- name: Check if Docker daemon is running
  ansible.builtin.command: docker info
  register: docker_status
  ignore_errors: yes

- name: Fail if Docker is not running
  ansible.builtin.fail:
    msg: "Docker daemon is not running on this host. Please start Docker before running this playbook."
  when: docker_status.rc != 0

- name: Ensure docker-compose.yml exists
  ansible.builtin.stat:
    path: "{{ docker_compose_service_path }}/docker-compose.yml"
  register: compose_file

- name: Fail if docker-compose.yml is missing
  ansible.builtin.fail:
    msg: "docker-compose.yml not found in {{ docker_compose_service_path }}"
  when: not compose_file.stat.exists

- name: Pull and restart Docker containers
  community.docker.docker_compose_v2:
    project_src: "{{ docker_compose_service_path }}"
    pull: always
    recreate: always
    state: present
  become: yes
  become_user: paul
  environment:
    PATH: "/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin"
  when: compose_file.stat.exists
